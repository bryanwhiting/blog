<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Feature engineering goes a long way!">

<title>Bryan Whiting - Handling Outliers in Linear Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SY4JFPWZ2N"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SY4JFPWZ2N', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="css/poem.css">
<meta property="og:title" content="Bryan Whiting - Handling Outliers in Linear Regression">
<meta property="og:description" content="Feature engineering goes a long way!">
<meta property="og:image" content="https://www.bryanwhiting.com/img/screenshot-chart-outlier-sales-only.jpeg">
<meta property="og:site_name" content="Bryan Whiting">
<meta name="twitter:title" content="Bryan Whiting - Handling Outliers in Linear Regression">
<meta name="twitter:description" content="Feature engineering goes a long way!">
<meta name="twitter:image" content="https://www.bryanwhiting.com/img/screenshot-chart-outlier-sales-only.jpeg">
<meta name="twitter:creator" content="@bryanwhiting">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Bryan Whiting
      </li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Handling Outliers in Linear Regression</h1>
                  <div>
        <div class="description">
          Feature engineering goes a long way!
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">tech</div>
                <div class="quarto-category">data science</div>
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">ml tips and tricks</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">analytics</div>
                <div class="quarto-category">tutorial</div>
                <div class="quarto-category">coding</div>
                <div class="quarto-category">pair programming</div>
                <div class="quarto-category">forecasting</div>
                <div class="quarto-category">outliers</div>
                <div class="quarto-category">ask gpt</div>
                <div class="quarto-category">principles of data science</div>
                <div class="quarto-category">time series</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Date</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Thursday February 8, 2024</p>
      </div>
    </div>
          <div>
      <div class="quarto-title-meta-heading">Topics</div>
      <div class="quarto-title-meta-contents">
                <div class="badge badge-small badge-grey quarto-category">tech</div>
                <div class="badge badge-small badge-grey quarto-category">data science</div>
                <div class="badge badge-small badge-grey quarto-category">machine learning</div>
                <div class="badge badge-small badge-grey quarto-category">ml tips and tricks</div>
                <div class="badge badge-small badge-grey quarto-category">regression</div>
                <div class="badge badge-small badge-grey quarto-category">analytics</div>
                <div class="badge badge-small badge-grey quarto-category">tutorial</div>
                <div class="badge badge-small badge-grey quarto-category">coding</div>
                <div class="badge badge-small badge-grey quarto-category">pair programming</div>
                <div class="badge badge-small badge-grey quarto-category">forecasting</div>
                <div class="badge badge-small badge-grey quarto-category">outliers</div>
                <div class="badge badge-small badge-grey quarto-category">ask gpt</div>
                <div class="badge badge-small badge-grey quarto-category">principles of data science</div>
                <div class="badge badge-small badge-grey quarto-category">time series</div>
            </div>
    </div>
      
  </div>  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Bryan Whiting</a> 
        <div class="sidebar-tools-main tools-wide">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/bryanwhiting/blog">
            This blog
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/bryanwhiting">
            Profile
            </a>
          </li>
      </ul>
    </div>
    <a href="https://www.linkedin.com/in/bryan-whiting/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://twitter.com/bryanwhiting" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="../index.xml" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-rss"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Blog</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Writing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tech.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tech, AI, and Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Posts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../books.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Book Reviews</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../christianity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Christianity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gratitude.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gratitude</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../creative.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Creative</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Other</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../goals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Goals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lists.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lists of Things</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sitemap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sitemap (All Posts)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#three-ways-to-handle-an-outlier" id="toc-three-ways-to-handle-an-outlier" class="nav-link active" data-scroll-target="#three-ways-to-handle-an-outlier">Three Ways to Handle an Outlier</a></li>
  <li><a href="#scenario-1-outlier-with-constant-effect" id="toc-scenario-1-outlier-with-constant-effect" class="nav-link" data-scroll-target="#scenario-1-outlier-with-constant-effect">Scenario 1: Outlier with constant effect</a></li>
  <li><a href="#scenario-2-non-constant-outliers" id="toc-scenario-2-non-constant-outliers" class="nav-link" data-scroll-target="#scenario-2-non-constant-outliers">Scenario 2: Non constant outliers</a></li>
  <li><a href="#appendix-code" id="toc-appendix-code" class="nav-link" data-scroll-target="#appendix-code">Appendix (Code)</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>So you have an outlier in your data. How do you handle it?</p>
<section id="three-ways-to-handle-an-outlier" class="level1">
<h1>Three Ways to Handle an Outlier</h1>
<p>Well, you can either include it or drop it from your data. If you include it, it may bias your regression coefficient.</p>
<p>Let’s assume you have some data where you have X = Emails Sent and Y = Sales. You want to know the effect of email on sales.</p>
<p>You have at least three options:</p>
<ul>
<li>A: fit the model on 100% if data, and don’t account for the outlier.</li>
<li>B: Create a dummy variable that’s 1 for outlier and 0 otherwise.</li>
<li>C: drop the outlier from your data and fit without a special feature.</li>
</ul>
<p>It turns out that options B and C are identical in their predictions for non-outlier time periods. Effectively, you isolate the effect of those outliers when you create a dummy variable for them. Let’s take a look.</p>
</section>
<section id="scenario-1-outlier-with-constant-effect" class="level1 page-columns page-full">
<h1>Scenario 1: Outlier with constant effect</h1>
<p>Here we have some sales data over time. You can see the outliers here are all relatively equally high:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../img/screenshot-chart-outlier-sales-only.jpeg" class="preview-image img-fluid figure-img"></p>
<figcaption class="margin-caption">Sales</figcaption>
</figure>
</div>
<p>Now I’m going to fit a model as above and get the “fitted values”, or in-sample predictions. We can see from this that the A model (no outlier treatment) has a higher line. This is the effect of the outlier on the slope. But the B model fits the data near perfectly. You’ll notice the C model and the B model are perfectly overlapping except for the gap on C (remember we dropped rows, so we didn’t have in-sample fitted values there!)</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../img/screenshot-chart-sales-in-sample.jpeg" class="preview-image img-fluid figure-img"></p>
<figcaption class="margin-caption">In sample predictions</figcaption>
</figure>
</div>
<p>Now, the model B is Y = intercept + email + is_holiday Boolean. If you make a prediction assuming is_holiday = 0 then you get the green line. This is the effect of making a prediction of what your sales would have been if it wasn’t a holiday. This is one way to get a “baseline”. Then the blue line is the predicted value with holiday = 1. The gap between blue and green is the effect of your holiday (I could show the model coefficients but I’m lazy!)</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../img/screenshot-chart-sales-fitted-and-non-fitted.jpeg" class="preview-image img-fluid figure-img"></p>
<figcaption class="margin-caption">Fitted and non-fitted B values</figcaption>
</figure>
</div>
<p>Okay, last interesting bit: what would the prediction of the model C be during this holiday period? Remember, we don’t have in-sample predictions (fitted values) because we dropped those rows. So technically, this middle spot is “out of sample” for model C.</p>
<p>What do we see? Well since the slope for “email” is the same for model C and B, the predictions are near identical. Let’s add in the model C non-fitted line:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../img/screenshot-chart-sales-model-c-out-of-sample.jpeg" class="preview-image img-fluid figure-img"></p>
<figcaption class="margin-caption">Predicting model C out of sample</figcaption>
</figure>
</div>
<p>What do we see? We see that model C (purple line) overlaps the green line perfectly.</p>
<p>So per this simple example, there are two ways of handling an outlier:</p>
<ol type="1">
<li>Drop it from your data (not ideal)</li>
<li>Use feature engineering to handle it (ideal)</li>
</ol>
<p>In a more complicated setting, there are tons of real world interactions in your data that make this even more complicated. But with good feature engineering you can isolate the effect of those outliers or subgroups.</p>
<p>I hope this helps. As always, always test the principle on your own data before fully trusting this principle. There may be something specific about your data or your model where this may not apply exactly (such as using decision trees or a GLM or GAM).</p>
<p>Lastly, it’s a beautiful world. You can ask ChatGPT to code up these analyses really quickly. Do you have a debate at work? Ask ChatGPT to run a simulation.</p>
</section>
<section id="scenario-2-non-constant-outliers" class="level1 page-columns page-full">
<h1>Scenario 2: Non constant outliers</h1>
<p>Now what if you have a holiday period AND a massive one-day spike (Black Friday)?</p>
<p>Here’s what the model predictions look like in green. <img src="../img/screenshot-chart-sales-3-massive-spike.jpeg" class="preview-image img-fluid" alt="Massive spike"></p>
<p>And this is where we start to see the Model C predictions (drop outliers) differ from model B:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../img/screenshot-chart-sales-massive-spike-3-compare-close-up.jpeg" class="preview-image img-fluid figure-img"></p>
<figcaption class="margin-caption">Dropping has different results than retaining</figcaption>
</figure>
</div>
<p>The predictions can differ by 10% or more. This means the coefficients can be wildly different, and that’s what we see. Model B’s email coefficient was 2.0 compared to just 1.1 for C. (Remember the model is <code>y ~ emails (+ holiday)</code>).</p>
<p>How do we solve this problem? Back to Scenario 1 - more feature engineering and interactions.</p>
<p>The solution (and exercise left for the reader) is to fit a new one-hot encoded feature for those separately spikey indexes.</p>
<p>Interpretation: if you believe there is a constant effect for your holiday period, you only need one holiday feature to not bias your emails coefficient.</p>
<p>If you see three distinct spiky periods, you need three holiday indicators: one either for the whole time period or just the middle 10 days and a second for the last 3 days (last spike) and third for the first two days (big spikes).</p>
<p>Basically, the more one-hot encoding you’re doing, the more you’re overfitting your model. If you identified every spike with a feature, it’s as if you’ve dropped them from the model <em>if</em> they have those spikes same average effect.</p>
<p>But if that average effect changes over time, you need to be smarter about your feature engineering.</p>
<p>To avoid overfitting philosophically, you should think about what generalizes. It doesn’t make sense to one-hot-encode every spike. Or maybe you had a freak event that causes a huge spike one day (a viral video). If that’s the case, you just have to accept the noise.</p>
<p>But if you believe that holiday period will happen in the future, you’re assuming it’ll behave like the prior holiday periods.</p>
<p>Other ideas you could try: one-hot encode the days before/after a holiday to capture ramp-up or ramp-down. Or scale your data by percentages so you’re making a prediction relative to the annual baseline or something (see the “other ways” below for a roughly similar idea).</p>
<p>Here’s are the principles:</p>
<ul>
<li>For every one-hot encoding you do, you assume that the average effect of that period across all data points is the same, plus some random error.</li>
<li>If that average effect isn’t the same, use multiple dummy features.</li>
<li>Only use one hot encoding where you think it’ll generalize to the future. Otherwise you’re overfitting or hindsight biasing your model.</li>
<li>Don’t treat big holiday periods (Christmas) the same as little periods. Give them each their own feature. # In Conclusion</li>
</ul>
<p>Feature engineering has a huge impact on your model’s ability to make good predictions. Also, it affects the interpretability of your model coefficients, which may be valuable in gaining insights from your data (such as what is the causal effect of email on revenue).</p>
<p>When you drop a row of data, you’re essentially creating a new model. You’re doing a type of feature engineering.</p>
<p>The better thing to do is to actually just do the feature engineering, because you’ll be able to generalize to similar data points like that in the future. # Other Ways to Handle Outliers</p>
<p>In this DoorDash blog, they provide a unique solution for XGBoost, mostly because XGBoost has a hard time extrapolating. But there are other ways to handle your data.</p>
<p><a href="../tech/holiday-demand-forecasting-using-xgboost.html">Holiday Demand Forecasting using XGBoost</a></p>
</section>
<section id="appendix-code" class="level1">
<h1>Appendix (Code)</h1>
<p>Here’s the code to reproduce the above, thanks to help with ChatGPT:</p>
<pre><code>import pandas as pd
import numpy as np
import statsmodels.api as sm
import plotly.express as px

SCENARIO1 = False # constant outliers
SCENARIO2 = True # non-constant outliers
SCENARIO3 = True # one super massive outlier


# Setting a random seed for reproducibility
np.random.seed(42)

# Generating a time series dataset
n = 100  # number of days
emails_sent = np.random.poisson(lam=50, size=n)  # average 50 emails sent per day
sales = 20 + 1.5 * emails_sent + np.random.normal(0, 10, n)  # base sales equation
is_holiday = np.zeros(n)

# Introducing an outlier (e.g., holiday sales)
indexes = [50, 51, 52, 53, 54, 55, 56, 57, 58, 59]
for ix in indexes:
    sales[ix] += 300 + np.random.normal(0, 10, 1)  # significant spike in sales
    is_holiday[ix] = 1  # flagging the outlier

if SCENARIO2:
    indexes = [60, 61, 62]
    for ix in indexes:
        sales[ix] += 400 + np.random.normal(0, 10, 1)  # significant spike in sales
        is_holiday[ix] = 1  # flagging the outlier

    indexes = [49]
    for ix in indexes:
        sales[ix] += 500 + np.random.normal(0, 10, 1)  # significant spike in sales
        is_holiday[ix] = 1  # flagging the outlier

    indexes = [48]
    for ix in indexes:
        sales[ix] += 1000 + np.random.normal(0, 10, 1)  # significant spike in sales
        is_holiday[ix] = 1  # flagging the outlier

# Preparing datasets for the three options
df = pd.DataFrame({‘emails_sent’: emails_sent, ‘sales’: sales, ‘is_holiday’: is_holiday})

# Option A: Including the outlier
X_A = sm.add_constant(df[‘emails_sent’])
y_A = df[‘sales’]

# Option B: Including the outlier and a dummy variable
X_B = sm.add_constant(df[[‘emails_sent’, ‘is_holiday’]])
y_B = df[‘sales’]

# Option C: Excluding the outlier
df_C = df[df[‘is_holiday’] == 0]
X_C = sm.add_constant(df_C[‘emails_sent’])
y_C = df_C[‘sales’]

# Fitting the models
model_A = sm.OLS(y_A, X_A).fit()
model_B = sm.OLS(y_B, X_B).fit()
model_C = sm.OLS(y_C, X_C).fit()


# Extracting the coefficients for the ‘emails_sent’ predictor
coef_A = model_A.params[‘emails_sent’]
coef_B = model_B.params[‘emails_sent’]
coef_C = model_C.params[‘emails_sent’]

model_A.summary()
model_B.summary()
model_C.summary()

(coef_A, coef_B, coef_C)



# Create a dataframe with the raw data
prediction_data = df[[‘emails_sent’, ‘sales’]].copy()

# Add predictions from each model to the dataframe
prediction_data[‘prediction_A’] = coef_A * prediction_data[‘emails_sent’] + model_A.params[‘const’]
prediction_data[‘prediction_B’] = coef_B * prediction_data[‘emails_sent’] + model_B.params[‘const’]
prediction_data[‘prediction_C’] = coef_C * prediction_data[‘emails_sent’] + model_C.params[‘const’]

prediction_data[‘prediction_A_fitted’] = model_A.fittedvalues
prediction_data[‘prediction_B_fitted’] = model_B.fittedvalues
prediction_data[‘prediction_C_fitted’] = model_C.fittedvalues

df_plt = prediction_data.drop(‘emails_sent’, axis=1).reset_index().melt(id_vars=[‘index’])

# Create a scatter plot of the raw data
fig = px.line(df_plt, x=‘index’, y=‘value’, color=‘variable’, title=‘Predidcted vs. actuals: Scenario 3’)
fig.update_layout(template=‘plotly_white’)
fig.show()
</code></pre>


</section>

<p>_________________________ <br> <br> <i><a href="https://www.bryanwhiting.com/about">Bryan</a> lives somewhere at the intersection of faith, fatherhood, and futurism and writes about <a href="https://www.bryanwhiting.com/tech">tech</a>, <a href="https://www.bryanwhiting.com/books">books</a>, <a href="https://www.bryanwhiting.com/christianity">Christianity</a>, <a href="https://www.bryanwhiting.com/gratitude">gratitude</a>, and <a href="https://www.bryanwhiting.com/">whatever’s on his mind</a>. If you liked reading, perhaps you’ll also like subscribing: <br><br> </i><iframe src="https://embeds.beehiiv.com/106e21ff-1989-43d2-9bd7-d4a4c4404ab6?slim=true" data-test-id="beehiiv-embed" height="52" frameborder="0" scrolling="no" style="margin: 0; border-radius: 0px !important; background-color: transparent;"></iframe></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.bryanwhiting\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="bryanwhiting/blog" data-repo-id="R_kgDOHgq18w" data-category="General" data-category-id="DIC_kwDOHgq1884CTE-n" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2021-2024, Bryan Whiting</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/bryanwhiting" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/bryan-whiting/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/bryanwhiting">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../index.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>