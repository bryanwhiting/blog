    # %e = non zero-padded day
    date = format(as.Date(date), "%a %m/%d")
  )
library(glue)
 df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{year(date)}, {month(date)}, {day(date)}")
  )
library(lubridate)
df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{year(date)}, {month(date)}, {day(date)}")
  )
lubridate::wday(4)
lubridate::weekday(4)
df_daily_goals_only
library(lubridate)
df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{wday(date, label=T)} {month(date)}/{day(date)}")
  )
# goals.R
library(dplyr)
library(ggplot2)
library(purrr)
library(tidyr)
library(gt)
library(lubridate)
################################################################
# Datasets
################################################################
bool_cols = c('sun', 'sss', 'water24oz', 'pray', 'meditate')
num_cols = c(
    "workout-time",
    "difficulty",
    "pelo-warmup",
    "pelo-time",
    "pelo-kj",
    "pelo-avg",
    "run-dist",
    "run-time",
    "hike-dist",
    "hike-elev",
    "hike-time",
    "basketball-time"
)
list_cols = c(
    "muscle-groups", 
    "exercises",
    "categories"
)
str_cols = c(
    "title",
    "description",
    "workout-vibe",
    "workout-notes"
)
extract_yaml_to_df <- function(file) {
  # file = "christianity/three-little-pigs-christ.md"  
  # cat("Reading file", file)
  file_content <- readLines(file)
  yaml_lines <- grep("---", file_content)
  yaml_start <- yaml_lines[1] + 1
  yaml_end <- yaml_lines[2] - 1
  # yaml content
  yaml_list <- file_content[(yaml_start):(yaml_end)]
  yaml_text = pas  yaml_text = pollapse = "\n")
  yaml_data <- y  yaml_dd_ya  yaml_data <- y )
                                                                ll         ist_fields <- names(yaml_data)[sapply(yaml_data, function(x) is.vect                                                           am          ld]                   l_                llapse=", ")
  }
  # missing yaml data columns get set to False
  fo  fo  fo  fo  co  fo  fo  fo  .n  fo  fo  fo  [co  fo  fo  fo  aml  fo  fo  fo  f FALSE
    } else {
                   col]] <- as.logical(yaml_data[[col]])
                  ol i           s, list_cols)){
    if(is.null(yaml_data[[col]])){
      yaml_data[[col]] <- "      yaml_data[[col]] <- "      yamll]] <- as.character(yaml_data[[col]])
    }
  }
  for(col in num_cols){
    if(is.null(    if(is.null(    if(is.null(  at    if(is.null(    if(is.null(    if(is.da    if(is.null(    if(is.null(  a[    if(is.null(    if(is.null(tibble::as_tibble(yaml_data))
}
# add gratitude
dirs <- c('goals', 'gratitude', "christianity")
df_raw <- tibble::tibble()
for(dir in dirs){
  files <- list.files(path = dir, pattern = "*.md", full.names = TRUE)
  for(file in files){
    # print(file)
    # convert to df
    df_new <- extract_yaml_to_df(file) 
    df_new$folder = dir
    df_raw <- bind_rows(df_raw, df_new)
  }
}
# add missing columsn
for(col in c('run-dist', 'hike-dist', 'jumprope-time')){
  if(!(col %in% colnames(df))){
    df_raw[[col]] <- 0
  }
}
# fill in missing defaults, characters are set to 'x' by default i# fill in missing defaults, characters are set to 'x' bn 'x' into NA
    across(where(is.character), ~ifelse(. == 'x', NA, .)),
    # parse j    # parse j    # parse j    # parse j    # parse j    # parse j    # parse j    # parse j    # par c("ymd", "ym    # parse j    # parHMS", "ymdHM"))),
    # create some flags
    post_cfm_study = stringr::str_detect(categories, 'come follow me'),
    post_gratitude = folder == 'gratitude',
    pelo = ifelse(`pelo-time` >     pelo = ifecardio = ifelse(
        `pelo-time` > 0 | 
                                                0 | 
        `jumprope-time` > 0 |
        `basketball-time` > 0 
                            h                 ex                  0)                            h         ##                      #######################################
# # tasets
###########################################################################_g############################## 9
df_daily_goals_only <- df_rawdf_daily_goals_only <- df_rawdf_daily_goals_only <- df_rawdf_daily_goals_only <- df_rawdf_daily_goals_only <- df_rawdf_daily_goals_onssdf_daily_goals_only <- df_rawdf_daily_goals_only <- df_rana(., 0))) %>%
  group_by(date) %>%
  summarize_all(max) %>%
  ungroup() %>%
  arrange(desc(date)) %>% 
  # sum the goals
  rowwise() %>%
  mutate(total_goals = sum(pray, meditate, strength, c  mutate(total_goals = sum(pray, meditate, strength, c  mutate(total_gro  mutate(total_goals = sum(pray, meditate,a.  mutate(total_goals = sum(pray, meditate,.Date("2024-12-31"), by = "days"))) %>%
  mutate  mutate  nth = lubridate::day(date)) %>%
  mutate(month_type = ifelse(lubridate::m  mutate(month_type = ifelse(
dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddy = 'date') %>%
  mutate(
    week_start_date = floor_date(date, "week"),
    day_of_week = wday(date, label = TRUE)
  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>  ) %>)} {month(date)}/{day(date)}")
  ) %>%
  select(
    `Day` = date,
    `📖` = post_cfm_study,
    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = post_gratitu    `🙏🏻` = p 'Day' column to the desired format
df_daily_goals_only_recent <- df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{wday(date, label=T)} {month(date)}/{day(date)}")
  ) %>%
  select(
    `Day` = date,
    `📖` = post_cfm_study,
    `🙏🏻` = post_gratitude,
    `🛐` = pray,
    `🚴🏻` = cardio,
    `🏋🏼‍♂️` = strength,
    `🧘🏼‍♂️` = meditate,
    `☀️` = sun,
    `🔗` = sss,
    `💧` = water24oz
  ) 
# Used for ggplot
df_plt_github_daily_habits <- left_join(df_yearly_calendar, df_date_goalcnt, by = 'date') %>%
  mutate(
    week_start_date = floor_date(date, "week"),
    day_of_week = wday(date, label = TRUE)
  ) %>%
  mutate(total_goals = replace_na(total_goals, 0))
df_daily_goals_only_recent <- df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{wday(date, label=T)} {month(date)}/{day(date)}")
  ) %>%
  select(
    `Day` = date,
    `📖` = post_cfm_study,
    `🙏🏻` = post_gratitude,
    `🛐` = pray,
    `��🏻` = cardio,
    `🏋🏼‍♂️` = strength,
    `🧘🏼‍♂️` = meditate,
    `☀️` = sun,
    `🔗` = sss,
    `💧` = water24oz
  ) 
df_daily_goals_only <- df_raw %>%
  select(
    date, pray, meditate, cardio, strength, post_cfm_study, post_gratitude, sun, sss, water24oz
  ) %>% 
  mutate(across(-date, as.numeric)) %>%
  mutate(across(-date, ~replace_na(., 0))) %>%
  group_by(date) %>%
  summarize_all(max) %>%
  ungroup() %>%
  arrange(desc(date)) %>% 
  # sum the goals
  rowwise() %>%
  mutate(total_goals = sum(pray, meditate, strength, cardio, post_cfm_study, post_gratitude, sun, sss, water24oz)) %>%
  ungroup()
df_daily_goals_only <- df_raw %>%
  select(
    date, pray, meditate, cardio, strength, post_cfm_study, post_gratitude, sun, sss, water24oz
  ) %>% 
  mutate(across(-date, as.numeric)) %>%
  mutate(across(-date, ~replace_na(., 0))) %>%
  group_by(date) %>%
  summarize_all(max) %>%
  ungroup() %>%
  arrange(desc(date)) %>% 
  # sum the goals
  rowwise() %>%
  mutate(total_goals = sum(pray, meditate, strength, cardio, post_cfm_study, post_gratitude, sun, sss, water24oz)) %>%
  ungroup()
df_raw %>%
  mutate(
    # Turn 'x' into NA
    across(where(is.character), ~ifelse(. == 'x', NA, .)),
    # parse just the date from datetime/date formats
    date = as.Date(lubridate::parse_date_time(date, orders = c("ymd", "ymd HMS", "ymd HM", "ymdHMS", "ymdHM"))),
    # create some flags
    post_cfm_study = stringr::str_detect(categories, 'come follow me'),
    post_gratitude = folder == 'gratitude',
    pelo = ifelse(`pelo-time` > 0, 1, 0),
    cardio = ifelse(
        `pelo-time` > 0 | 
        `run-dist` > 0 | 
        `hike-dist` > 0 | 
        `jumprope-time` > 0 |
        `basketball-time` > 0 
        , 1, 0),
    strength = ifelse(!is.na(exercises) >= 1, 1, 0)
  ) %>%
  filter(title != "test")
df_raw <- df_raw %>%
  mutate(
    # Turn 'x' into NA
    across(where(is.character), ~ifelse(. == 'x', NA, .)),
    # parse just the date from datetime/date formats
    date = as.Date(lubridate::parse_date_time(date, orders = c("ymd", "ymd HMS", "ymd HM", "ymdHMS", "ymdHM"))),
    # create some flags
    post_cfm_study = stringr::str_detect(categories, 'come follow me'),
    post_gratitude = folder == 'gratitude',
    pelo = ifelse(`pelo-time` > 0, 1, 0),
    cardio = ifelse(
        `pelo-time` > 0 | 
        `run-dist` > 0 | 
        `hike-dist` > 0 | 
        `jumprope-time` > 0 |
        `basketball-time` > 0 
        , 1, 0),
    strength = ifelse(!is.na(exercises) >= 1, 1, 0)
  ) %>%
  filter(title != "test")
library(dplyr)
library(ggplot2)
library(purrr)
library(tidyr)
library(gt)
library(lubridate)
library(stringr)
bool_cols = c('sun', 'sss', 'water24oz', 'pray', 'meditate')
num_cols = c(
    "workout-time",
    "difficulty",
    "pelo-warmup",
    "pelo-time",
    "pelo-kj",
    "pelo-avg",
    "run-dist",
    "run-time",
    "hike-dist",
    "hike-elev",
    "hike-time",
    "basketball-time"
)
list_cols = c(
    "muscle-groups", 
    "exercises",
    "categories"
)
str_cols = c(
    "title",
    "description",
    "workout-vibe",
    "workout-notes"
)
extract_yaml_to_df <- function(file) {
  # file = "christianity/three-little-pigs-christ.md"  
  # cat("Reading file", file)
  file_content <- readLines(file)
  yaml_lines <- grep("---", file_content)
  yaml_start <- yaml_lines[1] + 1
  yaml_end <- yaml_lines[2] - 1
  # yaml content
  yaml_list <- file_content[(yaml_start):(yaml_end)]
  yaml_text = paste(yaml_list, collapse = "\n")
  yaml_data <- yaml::read_yaml(text=yaml_text)
  yaml_data
  # Anything that's a vector should be listed and collapsed
  list_fields <- names(yaml_data)[sapply(yaml_data, function(x) is.vector(x) && length(x) > 1)]
  for(field in list_fields){
    yaml_data[field] = paste(unlist(yaml_data[field]), collapse=", ")
  }
  # missing yaml data columns get set to False
  for(col in bool_cols){
    if(is.null(yaml_data[[col]])){
      yaml_data[[col]] <- FALSE
    } else {
        yaml_data[[col]] <- as.logical(yaml_data[[col]])
    }
  }
  for(col in c(str_cols, list_cols)){
    if(is.null(yaml_data[[col]])){
      yaml_data[[col]] <- "x"
    } else {
        yaml_data[[col]] <- as.character(yaml_data[[col]])
    }
  }
  for(col in num_cols){
    if(is.null(yaml_data[[col]])){
      yaml_data[[col]] <- 0
    } else {
        yaml_data[[col]] <- as.numeric(yaml_data[[col]])
    }
  }
  
  return(tibble::as_tibble(yaml_data))
}
# add gratitude
dirs <- c('goals', 'gratitude', "christianity")
df_raw <- tibble::tibble()
for(dir in dirs){
  files <- list.files(path = dir, pattern = "*.md", full.names = TRUE)
  for(file in files){
    # print(file)
    # convert to df
    df_new <- extract_yaml_to_df(file) 
    df_new$folder = dir
    df_raw <- bind_rows(df_raw, df_new)
  }
}
# add missing columsn
for(col in c('run-dist', 'hike-dist', 'jumprope-time')){
  if(!(col %in% colnames(df))){
    df_raw[[col]] <- 0
  }
}
# fill in missing defaults, characters are set to 'x' by default in _day journal
df_raw <- df_raw %>%
  mutate(
    # Turn 'x' into NA
    across(where(is.character), ~ifelse(. == 'x', NA, .)),
    # parse just the date from datetime/date formats
    date = as.Date(lubridate::parse_date_time(date, orders = c("ymd", "ymd HMS", "ymd HM", "ymdHMS", "ymdHM"))),
    # create some flags
    post_cfm_study = stringr::str_detect(categories, 'come follow me'),
    post_gratitude = folder == 'gratitude',
    pelo = ifelse(`pelo-time` > 0, 1, 0),
    cardio = ifelse(
        `pelo-time` > 0 | 
        `run-dist` > 0 | 
        `hike-dist` > 0 | 
        `jumprope-time` > 0 |
        `basketball-time` > 0 
        , 1, 0),
    strength = ifelse(!is.na(exercises) >= 1, 1, 0)
  ) %>%
  filter(title != "test")
n_goals = 9
df_daily_goals_only <- df_raw %>%
  select(
    date, pray, meditate, cardio, strength, post_cfm_study, post_gratitude, sun, sss, water24oz
  ) %>% 
  mutate(across(-date, as.numeric)) %>%
  mutate(across(-date, ~replace_na(., 0))) %>%
  group_by(date) %>%
  summarize_all(max) %>%
  ungroup() %>%
  arrange(desc(date)) %>% 
  # sum the goals
  rowwise() %>%
  mutate(total_goals = sum(pray, meditate, strength, cardio, post_cfm_study, post_gratitude, sun, sss, water24oz)) %>%
  ungroup()
df_yearly_calendar <- bind_rows(data.frame(date = seq(as.Date("2024-01-01"), as.Date("2024-12-31"), by = "days"))) %>%
  mutate(day_of_month = lubridate::day(date)) %>%
  mutate(month_type = ifelse(lubridate::month(date) %% 2 == 0, 1, 0))
df_date_goalcnt <- df_daily_goals_only %>%
  select(date, total_goals) 
# Used for ggplot
df_plt_github_daily_habits <- left_join(df_yearly_calendar, df_date_goalcnt, by = 'date') %>%
  mutate(
    week_start_date = floor_date(date, "week"),
    day_of_week = wday(date, label = TRUE)
  ) %>%
  mutate(total_goals = replace_na(total_goals, 0))
df_daily_goals_only_recent <- df_daily_goals_only %>% 
  arrange(desc(date)) %>%
  head(15) %>%
  mutate(
    # %e = non zero-padded day
    date = glue::glue("{wday(date, label=T)} {month(date)}/{day(date)}")
  ) %>%
  select(
    `Day` = date,
    `📖` = post_cfm_study,
    `🙏🏻` = post_gratitude,
    `🛐` = pray,
    `🚴🏻` = cardio,
    `🏋��‍♂️` = strength,
    `🧘🏼‍♂️` = meditate,
    `☀️` = sun,
    `🔗` = sss,
    `💧` = water24oz
  ) 
# Peloton records
df_pelo_records <- df_raw %>% 
  filter(pelo == 1) %>%
  filter(date >= Sys.Date() - 60) %>%
  group_by(`pelo-time`) %>%
  filter(`pelo-kj` == max(`pelo-kj`)) %>%
  select(`pelo-time`, `pelo-kj`, `pelo-avg`, date, `workout-notes`) %>%
  ungroup() %>%
  mutate(`90%` = paste0("", .9 * `pelo-kj`, "KJ\n(", .9 * `pelo-avg`, "avg)")) %>%
  mutate(`80%` = paste0("", .8 * `pelo-kj`, "KJ (", .8 * `pelo-avg`, "avg)")) %>%
  mutate(`70%` = paste0("", .7 * `pelo-kj`, "KJ (", .7 * `pelo-avg`, "avg)"))
df_pelo_records
plt_github_daily_habits <- ggplot(df_plt_github_daily_habits, aes(x = week_start_date, y = day_of_week)) +
  theme_minimal() +
  # background shading - nearly works.
  # geom_tile(aes(color=as.factor(month_type)), show.legend = FALSE) + 
  # geom_tile(aes(color=as.factor(month_type))) + 
  # scale_color_manual(values = c("white", "lightgray")) +
  # add titles for goals
  # geom_tile( aes(color = total_goals), color = "white", width = 5, height = 0.9) +
  geom_tile(data=df_plt_github_daily_habits, aes(fill = total_goals), color = "white", width = 5, height = 0.9) + 
  scale_fill_gradient(low = "white", high = "darkgreen", limits = c(0, 6)) +
  labs(x = "", y = "", fill='Habits\nAccomplished', title = "Daily Success") +
  scale_x_date(limits = as.Date(c("2023-12-25", "2024-12-31")), labels = scales::date_format("%b")) +
  scale_y_discrete(limits = rev(levels(df_plt_github_daily_habits$day_of_week))) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.ticks = element_blank())
tab_l15_daily_habits <- df_daily_goals_only_recent %>%
  gt(id='mygt', rowname_col = "Day") %>%
  data_color(
    method = "numeric",
    palette = c("white", "darkgreen"),
    domain = c(0, 1)
  ) %>%
  tab_header(
    title = "Daily Habits"
  ) |>
  tab_style(
    style = list(
      cell_text(color = "transparent")
    ),
    locations = cells_body(
      columns = c(2:(n_goals + 1))  # replace with the actual column indices or names
    )
  ) %>%
  cols_align(align = "center") %>%
  tab_style(
    style = cell_borders(sides = "right", color = "white", weight = px(1)),
    locations = cells_body(columns = everything())
  ) %>%
  cols_width(
    Day ~ px(100),
    everything() ~ px(40),
  ) %>%
  tab_source_note(
    md("📖: Study, 🙏🏻: Gratitude, 🛐: Pray, 🚴🏻‍♂️: Cardio, 🏋🏼‍♂️: Strength, 🧘🏼‍♂️: Meditate")
  )
#' Peloton Records
#' 
tab_pelo_records <- gt() %>%
  cols_width(
    `90%` ~ px(70),
    `80%` ~ px(70),
    `70%` ~ px(70),
    # everything() ~ px(150),
  ) %>%
  cols_label(
    `pelo-time` = "Time",
    `pelo-kj` = "KJ",
    `pelo-avg` = "Avg W",
    `workout-notes` = "Notes",
    `date` = "Day"
  ) %>%
  tab_header(title = "Bike Records")
tab_pelo_records <- df_pelo_records %>%
 gt() %>%
  cols_width(
    `90%` ~ px(70),
    `80%` ~ px(70),
    `70%` ~ px(70),
    # everything() ~ px(150),
  ) %>%
  cols_label(
    `pelo-time` = "Time",
    `pelo-kj` = "KJ",
    `pelo-avg` = "Avg W",
    `workout-notes` = "Notes",
    `date` = "Day"
  ) %>%
  tab_header(title = "Bike Records")
tab_pelo_records
